# Day 1: Cart Service Implementation

## Overview
Build the Shopping Cart microservice for the e-commerce platform. The cart service manages user shopping carts, including adding/removing items and updating quantities. It validates products exist by calling the product service.

**Service Port:** 8083  
**Database:** PostgreSQL (cart-db)

---

## Tasks

### 1. Project Setup (~15 min)
- [ ] Create `go.mod` with module `github.com/herodragmon/scalable-ecommerce/services/cart-service`
- [ ] Configure `sqlc.yaml` for PostgreSQL code generation
- [ ] Create `.env.example` with required environment variables
- [ ] Create directory structure:
  ```
  services/cart-service/
  ├── internal/
  │   ├── config/
  │   ├── client/
  │   ├── handlers/
  │   ├── response/
  │   └── database/    (generated by sqlc)
  └── sql/
      ├── schema/
      └── queries/
  ```

---

### 2. Database Layer (~30 min)

#### Schema: `sql/schema/001_carts.sql`
- [ ] Create `carts` table:
  ```sql
  CREATE TABLE carts (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      user_id UUID NOT NULL UNIQUE,
      created_at TIMESTAMP NOT NULL DEFAULT now(),
      updated_at TIMESTAMP NOT NULL DEFAULT now()
  );
  ```
- [ ] Create `cart_items` table:
  ```sql
  CREATE TABLE cart_items (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      cart_id UUID NOT NULL REFERENCES carts(id) ON DELETE CASCADE,
      product_id UUID NOT NULL,
      quantity INT NOT NULL DEFAULT 1 CHECK (quantity > 0),
      price_cents INT NOT NULL,
      created_at TIMESTAMP NOT NULL DEFAULT now(),
      updated_at TIMESTAMP NOT NULL DEFAULT now(),
      UNIQUE(cart_id, product_id)
  );
  ```

#### Queries: `sql/queries/carts.sql`
- [ ] `GetCartByUserID` - Get cart for a user
- [ ] `CreateCart` - Create new cart for user
- [ ] `GetCartItems` - Get all items in a cart
- [ ] `GetCartItemByID` - Get single cart item
- [ ] `AddCartItem` - Insert item into cart
- [ ] `UpdateCartItemQuantity` - Update item quantity
- [ ] `DeleteCartItem` - Remove item from cart
- [ ] `ClearCart` - Delete all items from cart
- [ ] `DeleteCart` - Delete entire cart

#### Generate Code
- [ ] Run `sqlc generate` in cart-service directory

---

### 3. HTTP Client for Product Service (~20 min)

#### File: `internal/client/product.go`
- [ ] Create `ProductClient` struct with `BaseURL` and `HTTPClient`
- [ ] Create `Product` struct for response:
  ```go
  type Product struct {
      ID         uuid.UUID `json:"id"`
      Name       string    `json:"name"`
      PriceCents int32     `json:"price_cents"`
      Stock      int32     `json:"stock"`
  }
  ```
- [ ] Implement `GetProduct(ctx, productID)` method:
  - Returns `(*Product, bool, error)` - (product, exists, error)
  - Calls `GET http://product-service:8082/api/products/{id}`
  - Handle 404 as "not found" (exists=false)
  - Handle network errors appropriately

---

### 4. Core Application (~45 min)

#### Config: `internal/config/config.go`
- [ ] Create `Config` struct with:
  - `DB *database.Queries`
  - `Platform string`
  - `ProductServiceURL string`

#### Response: `internal/response/json.go`
- [ ] Copy from existing services (RespondWithJSON, RespondWithError)

#### Handlers: `internal/handlers/handlers.go`

| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| GET | `/health` | Health check | None |
| GET | `/api/cart` | Get user's cart with items | User (X-User-ID header) |
| POST | `/api/cart/items` | Add product to cart | User |
| PATCH | `/api/cart/items/{itemID}` | Update item quantity | User |
| DELETE | `/api/cart/items/{itemID}` | Remove item from cart | User |
| DELETE | `/api/cart` | Clear entire cart | User |
| GET | `/internal/cart/{userID}` | Get cart (for order service) | Internal |
| DELETE | `/internal/cart/{userID}` | Clear cart (after order placed) | Internal |

**Add to Cart Flow:**
1. Extract user ID from `X-User-ID` header (set by gateway)
2. Call product service to validate product exists
3. Get or create cart for user
4. Add item with product's current price
5. Return cart item

**Request/Response Examples:**
```
POST /api/cart/items
Request:  {"product_id": "uuid", "quantity": 2}
Response: {"id": "uuid", "product_id": "uuid", "quantity": 2, "price_cents": 999}

GET /api/cart
Response: {
  "id": "cart-uuid",
  "items": [
    {"id": "item-uuid", "product_id": "...", "quantity": 2, "price_cents": 999}
  ],
  "total_cents": 1998
}
```

#### Main: `main.go`
- [ ] Load environment variables
- [ ] Connect to database
- [ ] Initialize product client
- [ ] Register routes
- [ ] Start server on PORT (default 8083)

---

### 5. Docker Setup (~15 min)

#### Dockerfile
- [ ] Multi-stage build (builder + runtime)
- [ ] Use `golang:1.22-alpine` for builder
- [ ] Use `alpine:3.19` for runtime
- [ ] Expose port 8083

#### Update `docker-compose.yaml`
- [ ] Add `cart-db` service:
  ```yaml
  cart-db:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: carts
    volumes:
      - cart-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
  ```
- [ ] Add `cart-service` service:
  ```yaml
  cart-service:
    build:
      context: ./services/cart-service
      dockerfile: Dockerfile
    environment:
      PORT: "8083"
      PLATFORM: dev
      DB_URL: postgres://postgres:postgres@cart-db:5432/carts?sslmode=disable
      PRODUCT_SERVICE_URL: http://product-service:8082
    depends_on:
      cart-db:
        condition: service_healthy
      product-service:
        condition: service_started
    restart: unless-stopped
  ```
- [ ] Add `cart-db-data` to volumes section
- [ ] Update `api-gateway` to add `CART_SERVICE_URL` env var

---

### 6. API Gateway Integration (~15 min)

#### Update: `services/api-gateway/internal/proxy/proxy.go`
- [ ] Add cart service URL to config
- [ ] Add authenticated routes:
  ```go
  // Cart routes (all require auth)
  mux.HandleFunc("GET /api/cart", authMiddleware(cfg, proxyHandler(cfg.CartServiceURL, "/api/cart")))
  mux.HandleFunc("POST /api/cart/items", authMiddleware(cfg, proxyHandler(cfg.CartServiceURL, "/api/cart/items")))
  mux.HandleFunc("PATCH /api/cart/items/{itemID}", authMiddleware(cfg, proxyWithPathHandler(cfg.CartServiceURL, "/api/cart/items/")))
  mux.HandleFunc("DELETE /api/cart/items/{itemID}", authMiddleware(cfg, proxyWithPathHandler(cfg.CartServiceURL, "/api/cart/items/")))
  mux.HandleFunc("DELETE /api/cart", authMiddleware(cfg, proxyHandler(cfg.CartServiceURL, "/api/cart")))
  ```
- [ ] Pass `X-User-ID` header to downstream service in auth middleware

#### Update: `services/api-gateway/internal/config/config.go`
- [ ] Add `CartServiceURL string` to Config struct

#### Update: `services/api-gateway/main.go`
- [ ] Load `CART_SERVICE_URL` from environment

---

### 7. Testing (~20 min)

#### Build & Run
- [ ] `docker compose build`
- [ ] `docker compose up -d`
- [ ] Check logs: `docker compose logs -f cart-service`

#### Test Endpoints
```bash
# 1. Register a user
curl -X POST http://localhost:8080/api/users \
  -H "Content-Type: application/json" \
  -d '{"email": "test@example.com", "password": "password123"}'

# 2. Login to get token
curl -X POST http://localhost:8080/api/login \
  -H "Content-Type: application/json" \
  -d '{"email": "test@example.com", "password": "password123"}'
# Save the token from response

# 3. Create a product (need admin token - use mint_admin_jwt or create manually)
# For now, insert directly into product-db for testing

# 4. Add to cart
curl -X POST http://localhost:8080/api/cart/items \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{"product_id": "<product-uuid>", "quantity": 2}'

# 5. Get cart
curl http://localhost:8080/api/cart \
  -H "Authorization: Bearer <token>"

# 6. Update quantity
curl -X PATCH http://localhost:8080/api/cart/items/<item-id> \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{"quantity": 5}'

# 7. Remove item
curl -X DELETE http://localhost:8080/api/cart/items/<item-id> \
  -H "Authorization: Bearer <token>"

# 8. Clear cart
curl -X DELETE http://localhost:8080/api/cart \
  -H "Authorization: Bearer <token>"
```

---

## Estimated Total: ~2.5 hours

---

## Environment Variables Reference

```bash
# services/cart-service/.env.example
PORT=8083
PLATFORM=dev
DB_URL=postgres://postgres:postgres@localhost:5432/carts?sslmode=disable
PRODUCT_SERVICE_URL=http://localhost:8082
```

---

## Success Criteria
- [ ] All endpoints return correct responses
- [ ] Adding non-existent product returns 400 error
- [ ] Cart persists between requests
- [ ] Clearing cart removes all items
- [ ] Service runs in Docker alongside other services
- [ ] API Gateway correctly routes all cart requests
